<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Upload Files</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <a class="brand" href="index.html">health - Staffing</a>
        <nav class="main-nav">
          <a href="index.html">Add Candidate</a>
          <a href= "staffer.html">Payroll</a>
          <a href="upload.html" class="active">Upload</a>
        </nav>
      </div>
    </header>
    <main class="container">
      <section class="card form-card" aria-labelledby="upload-files">
        <h1 id="upload-files">Upload Documents</h1>

        <form id="uploadForm" class="grid-form">
          <div class="field" style="grid-column: 1 / -1">
            <label for="uploadFiles">Select Timesheet PDF Files</label>
            <input
              id="uploadFiles"
              name="uploadFiles"
              type="file"
              accept=".pdf,application/pdf"
              multiple
              required
            />
          </div>
          <div class="form-actions">
            <button type="submit" class="btn primary">Upload</button>
          </div>
        </form>

        <div id="uploadStatus" style="margin-top: 14px; color: #475569"></div>
        <div id="parsedResults" style="margin-top: 16px"></div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="container">&copy; <span id="year"></span> health Staffing</div>
    </footer>

    <script>
      document.getElementById("year").textContent = new Date().getFullYear();

      const API_URL = "http://localhost:5000/api";
      const uploadForm = document.getElementById("uploadForm");
      const statusEl = document.getElementById("uploadStatus");
      const resultsEl = document.getElementById("parsedResults");

      const escapeHtml = (text) =>
        text
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;");

      const TABLE_HEADERS = [
        ["name", "Name", "text"],
        ["area", "Area", "text"],
        ["week_ending", "Week Ending", "text"],
        ["reg_hours", "Reg Hours", "number"],
        ["w2_rate", "Reg Rate", "number"],
        ["ot_hours", "OT Hours", "number"],
        ["ot_rate", "OT Rate", "number"],
        ["holiday_rate", "Holiday Rate", "number"],
        ["holiday_hours", "Holiday Hours", "number"],
      ];
      const PAYROLL_HEADERS = [
        ["candidate_name", "NAME"],
        ["total_hours", "TOTAL"],
        ["reg_hours", "REG"],
        ["ot_hours", "OT"],
        ["holiday_hours", "HOL"],
        ["w2_rate", "W2"],
        ["stipend_rate", "STIPEND"],
        ["ot_rate", "OT RATE"],
        ["holiday_rate", "HOL RATE"],
        ["guaranteed", "GUAR"],
        ["standard_w2_amount", "STD W2"],
        ["ot_amount", "OT AMT"],
        ["holiday_amount", "HOL AMT"],
        ["sign_bonus", "BONUS"],
        ["overall_bonus", "OVERALL"],
        ["total_pay", "GUSTO PAY"],
        ["standard_stipend_amount", "STIPEND AMT"],
        ["total_payable", "TOTAL PAYABLE"],
        ["total_candidate_expense", "CANDIDATE EXP"],
        ["client_standard_bill_rate", "CLIENT STD"],
        ["vms_charges", "VMS"],
        ["client_standard_amount", "CLIENT STD AMT"],
        ["client_ot_bill_rate", "CLIENT OT"],
        ["client_holiday_bill_rate", "CLIENT HOL"],
        ["client_ot_holiday_amount", "OT/HOL AMT"],
        ["total_amount_received_from_client", "RECEIVED"],
        ["net_profit", "NET PROFIT"],
      ];
      const PAYROLL_EDITABLE_FIELDS = new Set([
        "reg_hours",
        "ot_hours",
        "holiday_hours",
        "w2_rate",
        "stipend_rate",
        "ot_rate",
        "holiday_rate",
        "sign_bonus",
        "client_standard_bill_rate",
        "client_ot_bill_rate",
        "client_holiday_bill_rate",
        "total_candidate_expense",
      ]);
      const previewState = new Map();

      function toCsv(rows) {
        const headers = TABLE_HEADERS.map((h) => h[0]);
        const escapeCsvCell = (value) => {
          const s = String(value ?? "");
          if (s.includes('"') || s.includes(",") || s.includes("\n")) {
            return `"${s.replace(/"/g, '""')}"`;
          }
          return s;
        };
        const lines = [headers.join(",")];
        rows.forEach((row) => {
          lines.push(headers.map((k) => escapeCsvCell(row[k])).join(","));
        });
        return lines.join("\n");
      }

      function buildEditableTable(item, index) {
        const safeId = `parsed_table_${index}`;
        const rows = Array.isArray(item.rows) ? item.rows : [];

        const tableRows = rows
          .map(
            (row, rowIndex) => `
            <tr data-row="${rowIndex}">
              ${TABLE_HEADERS.map(([key, _label, type]) => `
                <td>
                  <input
                    data-key="${key}"
                    type="${type}"
                    value="${escapeHtml(String(key === "w2_rate" ? (row.w2_rate ?? row.reg_rate ?? "") : (row[key] ?? "")))}"
                    style="width: 100%; min-width: 100px;"
                  />
                </td>
              `).join("")}
            </tr>
          `
          )
          .join("");

        return `
          <div class="card parsed-file" style="margin: 12px 0; padding: 16px;" data-table-id="${safeId}">
            <h3 style="margin: 0 0 10px;">${escapeHtml(item.filename)}</h3>
            <p style="margin: 0 0 12px; color: #334155;">Pages: ${item.pages ?? "-"} | Rows: ${rows.length}</p>
            <div style="overflow-x:auto;">
              <table class="payroll-table" id="${safeId}" style="width:100%;">
                <thead>
                  <tr>${TABLE_HEADERS.map(([, label]) => `<th>${escapeHtml(label)}</th>`).join("")}</tr>
                </thead>
                <tbody>
                  ${tableRows || `<tr><td colspan="${TABLE_HEADERS.length}" style="text-align:center;">No parsed rows found.</td></tr>`}
                </tbody>
              </table>
            </div>
            <div style="display:flex; gap:10px; margin-top:12px;">
              <button type="button" class="btn secondary" data-action="download-csv">Download CSV</button>
              <button type="button" class="btn primary" data-action="preview-payroll">Preview Payroll Table</button>
            </div>
            <p data-role="preview-message" style="margin:10px 0 0; color:#475569;"></p>
            <p data-role="missing-message" style="margin:6px 0 0; color:#b45309;"></p>
            <div data-role="payroll-preview"></div>
            ${item.parser_note ? `<p style="margin: 10px 0 0; color: #64748b;">${escapeHtml(item.parser_note)}</p>` : ""}
          </div>
        `;
      }

      function collectRowsFromTable(tableEl) {
        const rows = [];
        tableEl.querySelectorAll("tbody tr[data-row]").forEach((tr) => {
          const row = {};
          tr.querySelectorAll("input[data-key]").forEach((input) => {
            const key = input.dataset.key;
            if (input.type === "number") {
              row[key] = input.value === "" ? 0 : Number(input.value);
              if (Number.isNaN(row[key])) row[key] = 0;
            } else {
              row[key] = input.value.trim();
            }
          });
          rows.push(row);
        });
        return rows;
      }

      function bindParsedTableActions() {
        resultsEl.querySelectorAll(".parsed-file").forEach((card) => {
          const tableId = card.dataset.tableId;
          const tableEl = document.getElementById(tableId);
          if (!tableEl) return;

          const downloadBtn = card.querySelector('[data-action="download-csv"]');
          if (downloadBtn) {
            downloadBtn.addEventListener("click", () => {
              const rows = collectRowsFromTable(tableEl);
              const csv = toCsv(rows);
              const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = "timesheet_inputs.csv";
              document.body.appendChild(a);
              a.click();
              a.remove();
              URL.revokeObjectURL(url);
            });
          }

          const previewBtn = card.querySelector('[data-action="preview-payroll"]');
          if (previewBtn) {
            previewBtn.addEventListener("click", async () => {
              previewBtn.disabled = true;
              previewBtn.textContent = "Calculating...";
              const messageEl = card.querySelector('[data-role="preview-message"]');
              const missingEl = card.querySelector('[data-role="missing-message"]');
              const previewEl = card.querySelector('[data-role="payroll-preview"]');

              try {
                const parsedRows = collectRowsFromTable(tableEl);
                const candidatesRes = await fetch(`${API_URL}/candidates`);
                const candidates = await candidatesRes.json();
                const lookup = buildCandidateLookup(candidates || []);

                const missingNames = [];
                const matchedCandidateIds = new Set();
                const previewPayload = [];

                parsedRows.forEach((row) => {
                  const raw = row.name || "";
                  const match = findCandidateMatch(lookup, raw);

                  if (!match) {
                    missingNames.push(raw || "(blank)");
                    return;
                  }

                  matchedCandidateIds.add(match.candidate_uuid);
                  previewPayload.push({
                    id: match.candidate_uuid,
                    reg_hours: Number(row.reg_hours || 0),
                    ot_hours: Number(row.ot_hours || 0),
                    holiday_hours: Number(row.holiday_hours || 0),
                    w2_rate: Number(row.w2_rate || 0),
                    ot_rate: Number(row.ot_rate || 0),
                  });
                });

                if (!previewPayload.length) {
                  previewEl.innerHTML = "";
                  messageEl.style.color = "#b91c1c";
                  messageEl.textContent = "No parsed rows matched candidate names.";
                  if (missingEl) {
                    const missingCandidates = (candidates || []).map((c) => c.candidate_name);
                    missingEl.textContent = missingCandidates.length
                      ? `Candidates missing from this timesheet: ${missingCandidates.join(", ")}`
                      : "";
                  }
                  return;
                }

                const previewRes = await fetch(`${API_URL}/payroll/preview`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ candidates: previewPayload }),
                });
                const previewData = await previewRes.json();
                if (!previewRes.ok) {
                  throw new Error(previewData.error || "Payroll preview failed");
                }

                previewEl.innerHTML = renderPayrollTable(previewData.rows || []);
                previewState.set(tableId, previewData.rows || []);
                bindPreviewTableEditHandlers(card, tableId);
                messageEl.style.color = "#166534";
                messageEl.textContent = "Payroll preview generated.";

                if (missingEl) {
                  const missingCandidates = (candidates || [])
                    .filter((c) => !matchedCandidateIds.has(c.candidate_uuid))
                    .map((c) => c.candidate_name);

                  const parts = [];
                  if (missingNames.length) {
                    parts.push(`Unmatched parsed names skipped: ${missingNames.join(", ")}`);
                  }
                  if (missingCandidates.length) {
                    parts.push(
                      `Candidates missing from this timesheet: ${missingCandidates.join(", ")}`
                    );
                  }
                  missingEl.textContent = parts.join(" | ");
                }
              } catch (error) {
                messageEl.style.color = "#b91c1c";
                messageEl.textContent = error.message;
              } finally {
                previewBtn.disabled = false;
                previewBtn.textContent = "Preview Payroll Table";
              }
            });
          }
        });
      }

      function normalizeName(value) {
        return String(value || "")
          .toLowerCase()
          .replaceAll(",", " ")
          .replace(/\s+/g, " ")
          .trim();
      }

      function normalizeCommaName(value) {
        const raw = String(value || "");
        if (!raw.includes(",")) return normalizeName(raw);
        const parts = raw.split(",");
        const last = (parts[0] || "").trim();
        const first = (parts[1] || "").trim();
        return normalizeName(`${first} ${last}`);
      }

      function buildCandidateLookup(candidates) {
        const byNormalized = new Map();
        const byCompact = new Map();
        const byFirstLast = new Map();

        candidates.forEach((candidate) => {
          const key = normalizeName(candidate.candidate_name);
          if (key) {
            byNormalized.set(key, candidate);
            byCompact.set(key.replaceAll(" ", ""), candidate);
          }

          const parts = key.split(" ").filter(Boolean);
          if (parts.length === 2) {
            const reversed = `${parts[1]} ${parts[0]}`;
            byNormalized.set(reversed, candidate);
            byCompact.set(reversed.replaceAll(" ", ""), candidate);
          }

          const firstLastKey = getFirstLastKey(candidate.candidate_name);
          if (firstLastKey) byFirstLast.set(firstLastKey, candidate);
        });
        return { byNormalized, byCompact, byFirstLast };
      }

      function getFirstLastKey(name) {
        const raw = String(name || "").trim();
        if (!raw) return "";
        if (raw.includes(",")) {
          const [lastPart, firstPart] = raw.split(",");
          const last = (lastPart || "").trim().toLowerCase();
          const first = ((firstPart || "").trim().split(/\s+/)[0] || "").toLowerCase();
          return first && last ? `${first}|${last}` : "";
        }
        const parts = raw.toLowerCase().split(/\s+/).filter(Boolean);
        if (parts.length < 2) return "";
        const first = parts[0];
        const last = parts[parts.length - 1];
        return `${first}|${last}`;
      }

      function findCandidateMatch(lookup, parsedName) {
        const k1 = normalizeName(parsedName);
        const k2 = normalizeCommaName(parsedName);
        const compact1 = k1.replaceAll(" ", "");
        const compact2 = k2.replaceAll(" ", "");
        const firstLast = getFirstLastKey(parsedName);

        return (
          lookup.byNormalized.get(k1) ||
          lookup.byNormalized.get(k2) ||
          lookup.byCompact.get(compact1) ||
          lookup.byCompact.get(compact2) ||
          lookup.byFirstLast.get(firstLast) ||
          null
        );
      }

      function renderPayrollTable(rows) {
        return `
          <div style="overflow-x:auto; margin-top:12px;">
            <table class="payroll-table" style="width:100%;">
              <thead>
                <tr>${PAYROLL_HEADERS.map(([, label]) => `<th>${escapeHtml(label)}</th>`).join("")}</tr>
              </thead>
              <tbody>
                ${rows
                  .map((row, rowIndex) => `
                      <tr>
                        ${PAYROLL_HEADERS.map(([key]) => {
                          const editable = PAYROLL_EDITABLE_FIELDS.has(key);
                          return `<td data-row="${rowIndex}" data-key="${key}" ${editable ? 'contenteditable="true" class="editable"' : 'class="readonly"'}>${escapeHtml(String(row[key] ?? ""))}</td>`;
                        }).join("")}
                      </tr>
                    `)
                  .join("")}
              </tbody>
            </table>
          </div>
        `;
      }

      function parseNumberOrNull(v) {
        if (v === "" || v === null || v === undefined) return null;
        const n = Number(v);
        return Number.isNaN(n) ? null : n;
      }

      function bindPreviewTableEditHandlers(card, tableId) {
        const previewEl = card.querySelector('[data-role="payroll-preview"]');
        if (!previewEl) return;

        previewEl.querySelectorAll("td[contenteditable='true']").forEach((td) => {
          td.addEventListener("blur", async () => {
            const rows = previewState.get(tableId) || [];
            const rowIndex = Number(td.dataset.row);
            const key = td.dataset.key;
            if (!rows[rowIndex] || !key) return;

            rows[rowIndex][key] = parseNumberOrNull(td.textContent.trim()) ?? 0;

            const payload = rows.map((r) => ({
              id: r.candidate_uuid,
              reg_hours: parseNumberOrNull(r.reg_hours),
              ot_hours: parseNumberOrNull(r.ot_hours),
              holiday_hours: parseNumberOrNull(r.holiday_hours),
              w2_rate: parseNumberOrNull(r.w2_rate),
              stipend_rate: parseNumberOrNull(r.stipend_rate),
              ot_rate: parseNumberOrNull(r.ot_rate),
              holiday_rate: parseNumberOrNull(r.holiday_rate),
              sign_bonus: parseNumberOrNull(r.sign_bonus),
              client_standard_bill_rate: parseNumberOrNull(
                r.client_standard_bill_rate
              ),
              client_ot_bill_rate: parseNumberOrNull(r.client_ot_bill_rate),
              client_holiday_bill_rate: parseNumberOrNull(
                r.client_holiday_bill_rate
              ),
              total_candidate_expense: parseNumberOrNull(
                r.total_candidate_expense
              ),
            }));

            const messageEl = card.querySelector('[data-role="preview-message"]');
            try {
              const res = await fetch(`${API_URL}/payroll/preview`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ candidates: payload }),
              });
              const data = await res.json();
              if (!res.ok) throw new Error(data.error || "Payroll preview failed");
              previewState.set(tableId, data.rows || []);
              previewEl.innerHTML = renderPayrollTable(data.rows || []);
              bindPreviewTableEditHandlers(card, tableId);
              if (messageEl) {
                messageEl.style.color = "#166534";
                messageEl.textContent = "Recalculated using payroll formulas.";
              }
            } catch (error) {
              if (messageEl) {
                messageEl.style.color = "#b91c1c";
                messageEl.textContent = error.message;
              }
            }
          });
        });
      }

      uploadForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const files = document.getElementById("uploadFiles").files;

        if (!files.length) {
          alert("Please select at least one file.");
          return;
        }

        const formData = new FormData();
        for (const file of files) {
          formData.append("files", file);
        }

        statusEl.textContent = "Parsing timesheet PDF(s)...";
        resultsEl.innerHTML = "";

        try {
          const response = await fetch(`${API_URL}/timesheets/parse`, {
            method: "POST",
            body: formData,
          });

          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || "Failed to parse timesheets");
          }

          const blocks = (data.files || []).map((item, index) => {
            if (item.error) {
              return `
                <div class="card" style="margin: 12px 0; padding: 16px;">
                  <h3 style="margin: 0 0 10px;">${escapeHtml(item.filename)}</h3>
                  <p style="margin: 0; color: #b91c1c;">${escapeHtml(item.error)}</p>
                </div>
              `;
            }

            return buildEditableTable(item, index);
          });

          resultsEl.innerHTML = blocks.join("");
          bindParsedTableActions();
          statusEl.textContent = "Done.";
        } catch (error) {
          console.error(error);
          statusEl.textContent = `Error: ${error.message}`;
        }
      });
    </script>
  </body>
</html>
